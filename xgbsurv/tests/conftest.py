import pytest
import numpy as np
from xgbsurv.datasets import load_metabric
from xgbsurv.preprocessing.dataset_preprocessing import discretizer_df
from xgbsurv.models.utils import sort_X_y, transform_back


# test data for standard models




# test data for deephit

# phi array with 19 unique time stamps (=ncols)

phi = np.array([[0.56061679, 0.67018677, 0.830002  , 0.54249826, 0.06989779,
        0.37876414, 0.03824207, 0.39794583, 0.3478378 , 0.46833452,
        0.32292692, 0.70704927, 0.56557495, 0.58150488, 0.38871381,
        0.34848768, 0.39602859, 0.7649664 , 0.97185072],
       [0.95566696, 0.48104482, 0.75679969, 0.99386694, 0.91718885,
        0.49509238, 0.29452671, 0.29319748, 0.12167261, 0.34684764,
        0.20933687, 0.56328841, 0.04492321, 0.72173335, 0.79000414,
        0.50887818, 0.18630897, 0.53458442, 0.28050238],
       [0.15593853, 0.02782267, 0.01185559, 0.71230657, 0.81883045,
        0.4969608 , 0.74693123, 0.87947765, 0.31456862, 0.12872293,
        0.23845144, 0.64749992, 0.97677924, 0.57487316, 0.35761132,
        0.97724796, 0.8684253 , 0.68128472, 0.0869709 ],
       [0.99632921, 0.56681704, 0.95074056, 0.92120083, 0.76054228,
        0.27696215, 0.62860255, 0.70248436, 0.92183456, 0.70921057,
        0.76649902, 0.64107988, 0.24368451, 0.51152253, 0.80426748,
        0.74221419, 0.27668871, 0.17919406, 0.42808766],
       [0.27972894, 0.56866687, 0.6539161 , 0.5319978 , 0.99621816,
        0.33599839, 0.37512062, 0.14721801, 0.53298744, 0.50357236,
        0.38652909, 0.26062667, 0.77156399, 0.84954073, 0.68774531,
        0.47792277, 0.06867723, 0.76415557, 0.49115389],
       [0.79273291, 0.92759044, 0.81326807, 0.04226328, 0.98768654,
        0.07537023, 0.55331409, 0.22540424, 0.71398715, 0.7250366 ,
        0.32643635, 0.29281341, 0.46330328, 0.41149408, 0.13778508,
        0.03694444, 0.30238445, 0.44078415, 0.19661292],
       [0.75843055, 0.99731981, 0.94590159, 0.06033445, 0.20452619,
        0.76126846, 0.54285514, 0.7893368 , 0.38247081, 0.85430444,
        0.52043418, 0.18891051, 0.63758591, 0.37400696, 0.7804225 ,
        0.47204052, 0.56156778, 0.33566019, 0.3990119 ],
       [0.5306947 , 0.49757042, 0.69553678, 0.50663494, 0.44598667,
        0.21937834, 0.90704425, 0.65035354, 0.1341808 , 0.76539241,
        0.58519312, 0.98323395, 0.85668469, 0.02645247, 0.71319072,
        0.59216107, 0.21904393, 0.80283269, 0.38052726],
       [0.33536991, 0.56913116, 0.42259562, 0.68180137, 0.73365645,
        0.66044068, 0.97128302, 0.20019211, 0.73096269, 0.31609701,
        0.67428402, 0.48398141, 0.3843597 , 0.38371562, 0.36886752,
        0.0794369 , 0.03408211, 0.75023623, 0.68362319],
       [0.65184423, 0.48534751, 0.08064047, 0.78674504, 0.06255098,
        0.07844527, 0.196811  , 0.52218442, 0.81096049, 0.23212956,
        0.06336911, 0.14451082, 0.59268832, 0.44494552, 0.30831269,
        0.18509292, 0.7571426 , 0.78059063, 0.83033576],
       [0.1657391 , 0.98890883, 0.59125266, 0.80830763, 0.19778208,
        0.75399619, 0.71727879, 0.4851396 , 0.15589286, 0.73861217,
        0.511602  , 0.16323839, 0.66437389, 0.18004531, 0.81873861,
        0.07826153, 0.8947921 , 0.61635483, 0.43455631],
       [0.395005  , 0.97093084, 0.33062423, 0.23574601, 0.51486585,
        0.42856454, 0.94329152, 0.70344321, 0.57317513, 0.94632976,
        0.63672714, 0.99563958, 0.57327768, 0.03910801, 0.07771027,
        0.48566129, 0.85488311, 0.6057723 , 0.16950561],
       [0.59508459, 0.95045607, 0.92343267, 0.96820986, 0.06633364,
        0.83614061, 0.67577314, 0.74443865, 0.59352958, 0.51259308,
        0.03491607, 0.04434695, 0.85837897, 0.71040344, 0.02438701,
        0.99425333, 0.79017128, 0.12834676, 0.3988308 ],
       [0.68108959, 0.28834384, 0.81592558, 0.17091973, 0.21407878,
        0.23098784, 0.42014381, 0.85523219, 0.56613711, 0.61387742,
        0.55994703, 0.61032793, 0.65646759, 0.1812232 , 0.26260767,
        0.35116788, 0.64650932, 0.98678635, 0.52668915],
       [0.28992255, 0.40149962, 0.671999  , 0.87495982, 0.41206135,
        0.47103786, 0.83976069, 0.99689313, 0.53925724, 0.26320269,
        0.22911652, 0.97733889, 0.16904251, 0.42565559, 0.25421109,
        0.05060954, 0.51099776, 0.076741  , 0.71688287],
       [0.43050308, 0.08717614, 0.33684441, 0.7273216 , 0.48634413,
        0.7530504 , 0.52148584, 0.49021319, 0.23076744, 0.46344035,
        0.45206929, 0.56467496, 0.49647443, 0.4774734 , 0.90622309,
        0.57040588, 0.49141411, 0.28491756, 0.26073103],
       [0.44798068, 0.89615949, 0.30552967, 0.33349176, 0.95502655,
        0.91813918, 0.62428386, 0.84984507, 0.86836687, 0.78609441,
        0.47261591, 0.80318656, 0.13896811, 0.90963732, 0.05839439,
        0.83315826, 0.28216467, 0.1452794 , 0.70495897],
       [0.00463247, 0.51736001, 0.08070175, 0.11176686, 0.49550875,
        0.39094751, 0.65327167, 0.56788782, 0.73013999, 0.25124108,
        0.31757687, 0.58068344, 0.56020449, 0.69263596, 0.56677569,
        0.0296664 , 0.88003492, 0.21268497, 0.78623878],
       [0.3782029 , 0.81943188, 0.81412233, 0.52370451, 0.79590929,
        0.92546203, 0.59783995, 0.2973661 , 0.84875957, 0.64143599,
        0.45042338, 0.916713  , 0.39235494, 0.94565556, 0.82454687,
        0.89168315, 0.18688824, 0.97046952, 0.3591719 ],
       [0.88820103, 0.22469503, 0.09393979, 0.90702622, 0.2599165 ,
        0.38592207, 0.05689468, 0.74827846, 0.61047844, 0.97566285,
        0.75526081, 0.50752004, 0.94641458, 0.51176464, 0.42993403,
        0.86378897, 0.86438584, 0.12020468, 0.5326653 ]])


@pytest.fixture
def deephit_data(phi=phi):
    nrows = 20
    data, target = load_metabric(path="/Users/JUSC/Documents/xgbsurv/xgbsurv/datasets/data/", as_frame=False)
    data, target = sort_X_y(data, target)
    data = data[:nrows,:]
    target = target[:nrows]
    time, event = transform_back(target)
    ncols = len(np.unique(np.abs(target)))
    target = np.tile(target, (ncols,1)).T
    #print(ncols)
    #phi = np.random.rand(20, ncols)
    return time, event, target, phi

#time, event, target, phi = deephit_data()